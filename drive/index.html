<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnugOS Drive</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, let flex container handle it */
        }
        /* Custom styles for animations, if needed later */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100 text-gray-800">

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="text-xl font-semibold text-blue-600 animate-pulse">Loading...</div>
    </div>

    <!-- Message Dialog -->
    <div id="message-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto font-inter">
            <p id="message-text" class="text-gray-800 mb-6 text-center"></p>
            <div class="flex justify-center space-x-4">
                <button id="message-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-200 shadow-sm hidden">
                    Cancel
                </button>
                <button id="message-confirm-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 shadow-md">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Input Dialog -->
    <div id="input-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto font-inter">
            <h3 id="input-dialog-title" class="text-xl font-semibold text-gray-800 mb-4 text-center"></h3>
            <input
                type="text"
                id="input-dialog-field"
                placeholder=""
                class="w-full p-3 border border-gray-300 rounded-md mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div class="flex justify-end space-x-4">
                <button id="input-dialog-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition duration-200 shadow-sm">
                    Cancel
                </button>
                <button id="input-dialog-confirm-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200 shadow-md">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-purple-200 font-inter p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="auth-title" class="text-3xl font-bold text-center text-gray-800 mb-8">Login to SnugOS Drive</h2>
            <form id="auth-form" class="space-y-6">
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="username">
                        Username
                    </label>
                    <input
                        type="text"
                        id="username"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2" for="password">
                        Password
                    </label>
                    <input
                        type="password"
                        id="password"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <p id="auth-message" class="text-red-600 text-sm text-center hidden"></p>
                <button
                    type="submit"
                    id="auth-submit-btn"
                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                    <div id="auth-spinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3 hidden"></div>
                    <span id="auth-btn-text">Login</span>
                </button>
            </form>
            <div class="mt-8 text-center">
                <button id="toggle-auth-mode" class="text-blue-600 hover:underline text-sm font-medium">
                    Need an account? Register
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="flex flex-col h-full w-full hidden">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <!-- Folder Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-folder text-blue-600"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>
                <h1 class="text-2xl font-bold text-blue-600">SnugOS Drive</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="logged-in-user" class="text-gray-700 text-sm"></span>
                <button
                    id="logout-btn"
                    class="flex items-center px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200 shadow-sm"
                >
                    <!-- Logout Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-log-out mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex flex-grow overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-50 p-4 border-r border-gray-200 hidden md:block">
                <h2 class="text-lg font-semibold mb-4">Actions</h2>
                <ul class="space-y-2">
                    <li>
                        <button
                            id="create-folder-btn"
                            class="flex items-center w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 shadow-sm"
                        >
                            <!-- Plus Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-plus mr-2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                            New Folder
                        </button>
                    </li>
                    <li>
                        <input
                            type="file"
                            id="file-upload-input"
                            style="display: none;"
                        />
                        <button
                            id="upload-file-btn"
                            class="flex items-center w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition duration-200 shadow-sm"
                        >
                            <!-- Upload Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-upload mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            Upload File
                        </button>
                    </li>
                </ul>
            </aside>

            <!-- File Explorer -->
            <main class="flex-grow p-6 overflow-auto">
                <!-- Breadcrumbs -->
                <nav class="text-sm mb-4">
                    <ol id="breadcrumbs" class="list-none p-0 inline-flex">
                        <!-- Breadcrumbs will be dynamically inserted here -->
                    </ol>
                </nav>

                <!-- File/Folder List -->
                <div id="file-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    <!-- Files and folders will be dynamically inserted here -->
                </div>
            </main>
        </div>
    </div>

    <script>
        // Base URL for your backend server (change this if your server is hosted elsewhere)
        const BASE_URL = 'https://snugos.onrender.com/'; // Replace with your Render URL when deployed

        // Global state variables
        let token = localStorage.getItem('jwtToken');
        let currentUser = null; // Stores { id, username }
        let currentPath = '/';
        let authMode = 'login'; // 'login' or 'register'
        let confirmActionCallback = null;
        let inputDialogConfirmCallback = null;

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageDialog = document.getElementById('message-dialog');
        const messageText = document.getElementById('message-text');
        const messageConfirmBtn = document.getElementById('message-confirm-btn');
        const messageCancelBtn = document.getElementById('message-cancel-btn');
        const inputDialog = document.getElementById('input-dialog');
        const inputDialogTitle = document.getElementById('input-dialog-title');
        const inputDialogField = document.getElementById('input-dialog-field');
        const inputDialogConfirmBtn = document.getElementById('input-dialog-confirm-btn');
        const inputDialogCancelBtn = document.getElementById('input-dialog-cancel-btn');
        const loginPage = document.getElementById('login-page');
        const appContent = document.getElementById('app-content');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authMessage = document.getElementById('auth-message');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authBtnText = document.getElementById('auth-btn-text');
        const authSpinner = document.getElementById('auth-spinner');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const loggedInUserSpan = document.getElementById('logged-in-user');
        const logoutBtn = document.getElementById('logout-btn');
        const createFolderBtn = document.getElementById('create-folder-btn');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const fileUploadInput = document.getElementById('file-upload-input');
        const breadcrumbsNav = document.getElementById('breadcrumbs');
        const fileListDiv = document.getElementById('file-list');

        // --- Utility Functions for Modals ---

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(msg, onConfirm, showCancel = false, onCancel = null) {
            messageText.textContent = msg;
            messageCancelBtn.classList.toggle('hidden', !showCancel);
            messageDialog.classList.remove('hidden');

            // Clear previous event listeners to prevent multiple calls
            messageConfirmBtn.onclick = null;
            messageCancelBtn.onclick = null;

            messageConfirmBtn.onclick = () => {
                messageDialog.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            if (showCancel) {
                messageCancelBtn.onclick = () => {
                    messageDialog.classList.add('hidden');
                    if (onCancel) onCancel();
                };
            }
        }

        function showInputDialog(title, placeholder, initialValue, onConfirmCallback) {
            inputDialogTitle.textContent = title;
            inputDialogField.placeholder = placeholder;
            inputDialogField.value = initialValue;
            inputDialog.classList.remove('hidden');
            inputDialogField.focus();

            // Store the callback
            inputDialogConfirmCallback = onConfirmCallback;

            // Clear previous event listeners
            inputDialogConfirmBtn.onclick = null;
            inputDialogCancelBtn.onclick = null;

            inputDialogConfirmBtn.onclick = async () => {
                const value = inputDialogField.value.trim();
                const success = await inputDialogConfirmCallback(value);
                if (success) {
                    inputDialog.classList.add('hidden');
                }
            };

            inputDialogCancelBtn.onclick = () => {
                inputDialog.classList.add('hidden');
            };
        }

        // --- Icon SVGs (Inline) ---
        const getFolderIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-folder mr-3 flex-shrink-0 text-blue-500 group-hover:text-blue-600"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>`;
        const getFileIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-file-text mr-3 flex-shrink-0 text-gray-500 group-hover:text-gray-600"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v6h6"/><path d="M10 12H8"/><path d="M16 16H8"/><path d="M16 20H8"/></svg>`;
        const getEditIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const getTrashIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
        const getEyeIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        const getEyeOffIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a18.06 18.06 0 0 1 5.34-4.34M7.52 3.13A9.01 9.01 0 0 1 12 4c7 0 10 7 10 7a18.06 18.06 0 0 1-2.5 3.06"/><circle cx="12" cy="12" r="3"/><line x1="2" x2="22" y1="2" y2="22"/></svg>`;
        const getShareIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>`;

        // --- Authentication Functions ---

        async function fetchUserProfile() {
            if (!token) return;
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/profile/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.profile;
                    renderApp();
                } else {
                    console.error("Failed to fetch user profile:", response.statusText);
                    token = null;
                    localStorage.removeItem('jwtToken');
                    renderApp(); // Go back to login
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                token = null;
                localStorage.removeItem('jwtToken');
                renderApp(); // Go back to login
            } finally {
                hideLoading();
            }
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                authMessage.textContent = 'Please enter both username and password.';
                authMessage.classList.remove('hidden');
                return;
            }

            authMessage.classList.add('hidden');
            authSubmitBtn.disabled = true;
            authSpinner.classList.remove('hidden');
            authBtnText.textContent = authMode === 'register' ? 'Registering...' : 'Logging in...';

            try {
                const endpoint = authMode === 'register' ? '/api/register' : '/api/login';
                const response = await fetch(`${BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (data.success) {
                    token = data.token;
                    localStorage.setItem('jwtToken', token);
                    currentUser = data.user;
                    renderApp();
                } else {
                    authMessage.textContent = data.message || (authMode === 'register' ? 'Registration failed.' : 'Login failed.');
                    authMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Authentication error:", error);
                authMessage.textContent = 'Network error or server unavailable.';
                authMessage.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
                authSpinner.classList.add('hidden');
                authBtnText.textContent = authMode === 'register' ? 'Register' : 'Login';
            }
        }

        function handleLogout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('jwtToken');
            renderApp();
            showMessage('You have been logged out.');
        }

        // --- File Management Functions ---

        async function fetchFiles() {
            if (!token || !currentUser) {
                fileListDiv.innerHTML = ''; // Clear content if not logged in
                return;
            }

            showLoading();
            try {
                const encodedPath = encodeURIComponent(currentPath);
                const response = await fetch(`${BASE_URL}/api/files/my?path=${encodedPath}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    const sortedItems = data.items.sort((a, b) => {
                        const isAFolder = a.mime_type === 'application/vnd.snugos.folder';
                        const isBFolder = b.mime_type === 'application/vnd.snugos.folder';

                        if (isAFolder && !isBFolder) return -1;
                        if (!isAFolder && isBFolder) return 1;
                        return a.file_name.localeCompare(b.file_name);
                    });
                    renderFileList(sortedItems);
                } else {
                    showMessage(data.message || "Failed to load files.");
                    renderFileList([]);
                }
            } catch (error) {
                console.error("Error fetching files:", error);
                showMessage("Network error while fetching files. Please try again.");
                renderFileList([]);
            } finally {
                hideLoading();
            }
        }

        async function handleCreateFolder() {
            showInputDialog('Create New Folder', 'Folder Name', '', async (name) => {
                if (!name.trim()) {
                    showMessage("Folder name cannot be empty.");
                    return false;
                }
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/folders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name: name.trim(), path: currentPath })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage("Folder created successfully!");
                        fetchFiles(); // Re-fetch files to update UI
                        return true;
                    } else {
                        showMessage(data.message || "Failed to create folder.");
                        return false;
                    }
                } catch (error) {
                    console.error("Error creating folder:", error);
                    showMessage("Network error creating folder.");
                    return false;
                } finally {
                    hideLoading();
                }
            });
        }

        function handleUploadClick() {
            fileUploadInput.click();
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', currentPath);
            formData.append('is_public', false); // Default to private

            try {
                const response = await fetch(`${BASE_URL}/api/files/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(`File "${file.name}" uploaded successfully!`);
                    fetchFiles(); // Re-fetch files
                } else {
                    showMessage(data.message || "Failed to upload file.");
                }
            } catch (error) {
                console.error("Error uploading file:", error);
                showMessage("Network error uploading file.");
            } finally {
                event.target.value = null; // Reset file input
                hideLoading();
            }
        }

        function handleRename(item) {
            showInputDialog(`Rename ${item.file_name}`, 'New Name', item.file_name, async (newName) => {
                if (!newName.trim()) {
                    showMessage("Name cannot be empty.");
                    return false;
                }
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/files/${item.id}/rename`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ newName: newName.trim() })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage("Item renamed successfully.");
                        fetchFiles(); // Re-fetch files
                        return true;
                    } else {
                        showMessage(data.message || "Failed to rename item.");
                        return false;
                    }
                } catch (error) {
                    console.error("Error renaming item:", error);
                    showMessage("Network error renaming item.");
                    return false;
                } finally {
                    hideLoading();
                }
            });
        }

        function handleDeleteItem(item) {
            showMessage(`Are you sure you want to delete "${item.file_name}"? This action cannot be undone.`, async () => {
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/files/${item.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage(`"${item.file_name}" deleted successfully.`);
                        fetchFiles(); // Re-fetch files
                    } else {
                        showMessage(data.message || "Failed to delete item.");
                    }
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showMessage("Network error deleting item.");
                } finally {
                    hideLoading();
                }
            }, true); // showCancel = true
        }

        async function handleTogglePublic(item) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/files/${item.id}/toggle-public`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ is_public: !item.is_public })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(`"${item.file_name}" is now ${data.file.is_public ? 'public' : 'private'}.`);
                    fetchFiles(); // Re-fetch files
                } else {
                    showMessage(data.message || "Failed to change public status.");
                }
            } catch (error) {
                console.error("Error toggling public status:", error);
                showMessage("Network error changing public status.");
            } finally {
                hideLoading();
            }
        }

        async function handleShareLink(item) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/files/${item.id}/share-link`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    navigator.clipboard.writeText(data.shareUrl).then(() => {
                        showMessage("Share link copied to clipboard!");
                    }).catch(err => {
                        // Fallback for older browsers or if clipboard API fails (e.g., iframe restrictions)
                        const textarea = document.createElement('textarea');
                        textarea.value = data.shareUrl;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showMessage("Share link copied to clipboard! (Fallback method)");
                        console.warn("Clipboard API not available, falling back to execCommand.");
                    });
                } else {
                    showMessage(data.message || "Failed to generate share link.");
                }
            } catch (error) {
                console.error("Error generating share link:", error);
                showMessage("Network error generating share link.");
            } finally {
                hideLoading();
            }
        }

        // --- UI Rendering Functions ---

        function renderBreadcrumbs() {
            breadcrumbsNav.innerHTML = '';
            const pathSegments = currentPath.split('/').filter(segment => segment !== '');

            let myDriveLi = document.createElement('li');
            myDriveLi.className = 'flex items-center';
            let myDriveBtn = document.createElement('button');
            myDriveBtn.className = 'text-blue-600 hover:underline font-medium';
            myDriveBtn.textContent = 'My Drive';
            myDriveBtn.onclick = () => {
                currentPath = '/';
                renderApp();
            };
            myDriveLi.appendChild(myDriveBtn);
            breadcrumbsNav.appendChild(myDriveLi);

            let accumulatedPath = '/';
            pathSegments.forEach((segment, index) => {
                accumulatedPath += segment + '/';
                let li = document.createElement('li');
                li.className = 'flex items-center';
                li.innerHTML = '<span class="mx-2 text-gray-400">/</span>';
                let btn = document.createElement('button');
                btn.className = 'text-blue-600 hover:underline font-medium';
                btn.textContent = segment;
                // Capture the path for this segment in a closure
                const navPath = accumulatedPath;
                btn.onclick = () => {
                    currentPath = navPath;
                    renderApp();
                };
                li.appendChild(btn);
                breadcrumbsNav.appendChild(li);
            });
        }

        function renderFileList(items) {
            fileListDiv.innerHTML = ''; // Clear previous items

            if (items.length === 0) {
                fileListDiv.innerHTML = `
                    <p class="col-span-full text-center text-gray-500 py-8">
                        This folder is empty. Create a new folder or upload a file!
                    </p>
                `;
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-200 p-4 flex flex-col items-start space-y-3';

                const isFolder = item.mime_type === 'application/vnd.snugos.folder';
                const nameElement = document.createElement(isFolder ? 'button' : 'a');
                nameElement.className = 'flex items-center text-left group w-full ' + (isFolder ? 'text-blue-600 hover:text-blue-700' : 'text-gray-700 hover:text-gray-900');
                nameElement.innerHTML = (isFolder ? getFolderIcon() : getFileIcon()) + `<span class="font-${isFolder ? 'semibold' : 'medium'} text-lg truncate flex-grow">${item.file_name}</span>`;

                if (isFolder) {
                    nameElement.onclick = () => {
                        currentPath = currentPath === '/' ? `/${item.file_name}/` : `${currentPath}${item.file_name}/`;
                        renderApp();
                    };
                } else {
                    nameElement.href = item.s3_url;
                    nameElement.target = '_blank';
                    nameElement.rel = 'noopener noreferrer';
                }
                itemDiv.appendChild(nameElement);

                // Actions div
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex flex-wrap gap-2 pt-2 border-t border-gray-100 w-full justify-start mt-auto';

                // Rename Button
                const renameBtn = document.createElement('button');
                renameBtn.className = 'p-2 rounded-full hover:bg-gray-200 transition duration-150';
                renameBtn.title = 'Rename';
                renameBtn.innerHTML = getEditIcon();
                renameBtn.onclick = () => handleRename(item);
                actionsDiv.appendChild(renameBtn);

                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'p-2 rounded-full hover:bg-red-100 text-red-600 transition duration-150';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = getTrashIcon();
                deleteBtn.onclick = () => handleDeleteItem(item);
                actionsDiv.appendChild(deleteBtn);

                if (!isFolder) {
                    // Toggle Public Button
                    const togglePublicBtn = document.createElement('button');
                    togglePublicBtn.className = 'p-2 rounded-full hover:bg-purple-100 text-purple-600 transition duration-150';
                    togglePublicBtn.title = item.is_public ? "Make Private" : "Make Public";
                    togglePublicBtn.innerHTML = item.is_public ? getEyeOffIcon() : getEyeIcon();
                    togglePublicBtn.onclick = () => handleTogglePublic(item);
                    actionsDiv.appendChild(togglePublicBtn);

                    // Share Link Button
                    const shareLinkBtn = document.createElement('button');
                    shareLinkBtn.className = 'p-2 rounded-full hover:bg-yellow-100 text-yellow-600 transition duration-150';
                    shareLinkBtn.title = 'Get Share Link';
                    shareLinkBtn.innerHTML = getShareIcon();
                    shareLinkBtn.onclick = () => handleShareLink(item);
                    actionsDiv.appendChild(shareLinkBtn);
                }

                itemDiv.appendChild(actionsDiv);
                fileListDiv.appendChild(itemDiv);
            });
        }

        // --- Main App Renderer ---
        function renderApp() {
            if (token && currentUser) {
                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
                loggedInUserSpan.innerHTML = `Logged in as: <span class="font-semibold">${currentUser.username}</span>`;
                renderBreadcrumbs();
                fetchFiles();
            } else {
                loginPage.classList.remove('hidden');
                appContent.classList.add('hidden');
                // Reset login/register form
                usernameInput.value = '';
                passwordInput.value = '';
                authMessage.classList.add('hidden');
                authSpinner.classList.add('hidden');
                authSubmitBtn.disabled = false;
                if (authMode === 'register') {
                    authTitle.textContent = 'Register to SnugOS Drive';
                    authBtnText.textContent = 'Register';
                    toggleAuthModeBtn.textContent = 'Already have an account? Login';
                } else {
                    authTitle.textContent = 'Login to SnugOS Drive';
                    authBtnText.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Need an account? Register';
                }
            }
        }

        // --- Event Listeners ---
        window.onload = () => {
            renderApp(); // Initial render based on existing token
        };

        authForm.addEventListener('submit', handleAuthSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        createFolderBtn.addEventListener('click', handleCreateFolder);
        uploadFileBtn.addEventListener('click', handleUploadClick);
        fileUploadInput.addEventListener('change', handleFileUpload);

        toggleAuthModeBtn.addEventListener('click', () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            renderApp();
        });

    </script>
</body>
</html>
