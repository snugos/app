<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnugOS Drive</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* SnugOS Stylesheet - Integrated Variables (Dark Mode Default) */
        :root {
            --bg-primary: #000000;
            --bg-window: #000000;
            --bg-window-content: #000000;
            --bg-title-bar: #000000;
            --bg-taskbar: #000000;
            --bg-start-menu: #000000;
            --bg-button: #000000;
            --bg-button-hover: #FFFFFF;
            --bg-button-active: #FFFFFF;
            --bg-input: #000000;
            --bg-dropzone: #000000;
            --bg-dropzone-dragover: #FFFFFF;
            --bg-modal-overlay: rgba(0,0,0,0.75);
            --bg-modal-dialog: #000000;

            --text-primary: #FFFFFF;
            --text-secondary: #FFFFFF;
            --text-placeholder: #FFFFFF;
            --text-title-bar: #FFFFFF;
            --text-button: #FFFFFF;
            --text-button-hover: #000000;
            --text-dropzone: #FFFFFF;
            --text-dropzone-dragover: #000000;

            --border-primary: #FFFFFF;
            --border-secondary: #FFFFFF;
            --border-window-title-bottom: #FFFFFF;
            --border-button: #FFFFFF;
            --border-button-hover: #FFFFFF;
            --border-button-active-outer: #FFFFFF;
            --border-button-active-inner: #FFFFFF;
            --border-input: #FFFFFF;
            --border-dropzone: #FFFFFF;
            --border-dropzone-dragover: #FFFFFF;
            --border-modal: #FFFFFF;

            --shadow-window: none; /* Not directly used, but kept for completeness */
            --shadow-button-inset-main: #000000;
            --shadow-button-inset-secondary: #000000;
            --shadow-modal: none;

            --accent-focus: #FFFFFF;
            --accent-active: #FFFFFF;
            --accent-active-text: #000000;
            --accent-armed: #FF0000; /* Red for armed/recording */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            text-transform: lowercase; /* Apply system-wide lowercase as per SnugOS stylesheet */
        }

        /* General Button Styling (Consolidated from SnugOS stylesheet) */
        /* Applied to relevant buttons in the HTML */
        button {
            padding: 5px 8px; /* Consistent padding */
            border: 1px solid var(--border-button); /* Consistent border */
            border-radius: 3px; /* Consistent border-radius */
            font-size: 14px; /* Default font size, adjusted from 11px to fit modern UI better */
            height: 38px; /* Adjusted height for better touch target */
            min-width: 30px;
            box-sizing: border-box;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
            background-color: var(--bg-button);
            color: var(--text-button);
        }

        button:hover {
            background-color: var(--bg-button-hover);
            border-color: var(--border-button-hover);
            color: var(--text-button-hover);
        }

        button:active {
            background-color: var(--bg-button-active);
            border-color: var(--border-button-active-outer);
            box-shadow: inset 1px 1px 0 var(--shadow-button-inset-main), inset -1px -1px 0 var(--shadow-button-inset-secondary);
        }

        /* Specific styles for action buttons in file list (smaller icons) */
        .item-action-btn {
            padding: 8px; /* Increased padding for better touch target */
            width: 38px; /* Fixed size for circular appearance */
            height: 38px;
            border-radius: 50%; /* Make them circular */
            border: 1px solid var(--border-button);
            background-color: var(--bg-button);
            color: var(--text-button);
        }

        .item-action-btn:hover {
            background-color: var(--bg-button-hover);
            border-color: var(--border-button-hover);
            color: var(--text-button-hover);
        }

        .item-action-btn:active {
            background-color: var(--bg-button-active);
            border-color: var(--border-button-active-outer);
            box-shadow: inset 1px 1px 0 var(--shadow-button-inset-main), inset -1px -1px 0 var(--shadow-button-inset-secondary);
        }


        /* Input and Select General Styling */
        input[type="text"], input[type="password"] {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-input);
            padding: 5px 8px;
            border-radius: 3px;
        }

        input::placeholder {
            color: var(--text-placeholder);
        }

        /* Modal Styling */
        #message-dialog > div, #input-dialog > div { /* Target the inner dialog box */
            background-color: var(--bg-modal-dialog);
            border: 1px solid var(--border-modal);
            box-shadow: var(--shadow-modal);
            color: var(--text-primary);
        }

        /* Global Loading Overlay */
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Style for drag and drop hover effect */
        .drop-target-hover {
            outline: 2px dashed var(--border-dropzone-dragover);
            outline-offset: 4px;
            background-color: var(--bg-dropzone-dragover);
        }

        /* Custom Scrollbar Styling (from SnugOS stylesheet) */
        ::-webkit-scrollbar { width: 10px; height: 10px;}
        ::-webkit-scrollbar-track { background: var(--scrollbar-track, #000000); border-radius: 0px;}
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb, #FFFFFF); border-radius: 2px; border: 1px solid var(--scrollbar-thumb-border, #000000);}
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover, #FFFFFF);}
        ::-webkit-scrollbar-corner { background: var(--scrollbar-corner, #000000);}
        * { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb, #FFFFFF) var(--scrollbar-track, #000000);}

    </style>
    <!-- Google API Client Library -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Google Picker API -->
    <script src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
</head>
<body class="flex flex-col h-screen bg-gray-100 text-gray-800">

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-200 bg-opacity-75 flex items-center justify-center z-[100] hidden">
        <div class="text-xl font-semibold text-blue-600 animate-pulse">Loading...</div>
    </div>

    <!-- Message Dialog -->
    <div id="message-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto font-inter">
            <p id="message-text" class="mb-6 text-center"></p>
            <div class="flex justify-center space-x-4">
                <button id="message-cancel-btn" class="hidden">
                    Cancel
                </button>
                <button id="message-confirm-btn">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Input Dialog -->
    <div id="input-dialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="rounded-xl shadow-lg p-6 max-w-sm w-full mx-auto font-inter">
            <h3 id="input-dialog-title" class="text-xl font-semibold mb-4 text-center"></h3>
            <input
                type="text"
                id="input-dialog-field"
                placeholder=""
                class="w-full p-3 mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div class="flex justify-end space-x-4">
                <button id="input-dialog-cancel-btn">
                    Cancel
                </button>
                <button id="input-dialog-confirm-btn">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-purple-200 font-inter p-4 hidden">
        <div class="p-8 rounded-xl shadow-2xl w-full max-w-md" style="background-color: var(--bg-window); color: var(--text-primary); border: 1px solid var(--border-primary);">
            <h2 id="auth-title" class="text-3xl font-bold text-center mb-8">Login to SnugOS Drive</h2>
            <form id="auth-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2" for="username">
                        Username
                    </label>
                    <input
                        type="text"
                        id="username"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2" for="password">
                        Password
                    </label>
                    <input
                        type="password"
                        id="password"
                        class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                    />
                </div>
                <p id="auth-message" class="text-red-600 text-sm text-center hidden"></p>
                <button
                    type="submit"
                    id="auth-submit-btn"
                    class="w-full py-3 rounded-lg font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                    <div id="auth-spinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3 hidden"></div>
                    <span id="auth-btn-text">Login</span>
                </button>
            </form>
            <div class="mt-8 text-center space-y-4">
                <button id="toggle-auth-mode" class="text-blue-600 hover:underline text-sm font-medium" style="color: var(--text-primary);">
                    Need an account? Register
                </button>
                <button id="google-login-btn" class="flex items-center justify-center w-full py-3 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 transition duration-300 shadow-lg">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.24 10.285V11.23h1.615c-.086.58-.456 1.455-1.615 1.455-1.936 0-3.5-1.563-3.5-3.5s1.563-3.5 3.5-3.5c1.025 0 1.79.438 2.228.847L15.355 5.5c-.715-.655-1.652-1.07-3.115-1.07-2.923 0-5.32 2.396-5.32 5.32s2.396 5.32 5.32 5.32c3.003 0 5.023-2.07 5.023-5.18 0-.336-.035-.615-.086-.902z" fill="#4285F4"></path><path d="M11.996 16.5c-1.306 0-2.5-.473-3.322-1.28L6.482 17.5C7.945 18.795 9.87 19.5 11.996 19.5c2.146 0 4.09-.766 5.556-2.062l-1.92-1.5c-.77.585-1.748.962-2.836.962z" fill="#34A853"></path><path d="M4.032 10.75V13.25H6.532V10.75H4.032z" fill="#FBBC05"></path><path d="M19.5 12c0-.528-.05-.88-.135-1.25L19.5 12z" fill="#EA4335"></path>
                    </svg>
                    Login with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Content -->
    <div id="app-content" class="flex flex-col h-full w-full hidden" style="background-color: var(--bg-primary);">
        <!-- Header -->
        <header class="shadow-md p-4 flex items-center justify-between" style="background-color: var(--bg-title-bar); color: var(--text-title-bar);">
            <div class="flex items-center space-x-2">
                <!-- Folder Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-folder" style="color: var(--text-title-bar);"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>
                <h1 class="text-2xl font-bold">SnugOS Drive</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="logged-in-user" class="text-gray-700 text-sm" style="color: var(--text-primary);"></span>
                <button
                    id="logout-btn"
                    class="flex items-center px-4 py-2 rounded-md shadow-sm"
                >
                    <!-- Logout Icon SVG -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-log-out mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex flex-grow overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 p-4 border-r" style="background-color: var(--bg-window); border-color: var(--border-secondary);">
                <h2 class="text-lg font-semibold mb-4">Actions</h2>
                <ul class="space-y-2">
                    <li>
                        <button
                            id="create-folder-btn"
                            class="flex items-center w-full px-4 py-2 rounded-md shadow-sm"
                        >
                            <!-- Plus Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-plus mr-2"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                            New Folder
                        </button>
                    </li>
                    <li>
                        <input
                            type="file"
                            id="file-upload-input"
                            style="display: none;"
                        />
                        <button
                            id="upload-file-btn"
                            class="flex items-center w-full px-4 py-2 rounded-md shadow-sm"
                        >
                            <!-- Upload Icon SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-upload mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                            Upload File
                        </button>
                    </li>
                    <li>
                        <button
                            id="import-google-drive-btn"
                            class="flex items-center w-full px-4 py-2 rounded-md shadow-sm"
                            style="background-color: #DB4437; color: white;"
                        >
                            <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.283 10.356c0 .101.018.201.031.301H12v3.666h4.869c-.218 1.133-1.094 2.366-2.881 2.366-2.19 0-3.987-1.777-3.987-3.978s1.797-3.978 3.987-3.978c1.114 0 1.842.463 2.383.983l2.848-2.766C17.95 4.887 16.141 4 12.283 4 7.218 4 3 8.016 3 13s4.218 9 9.283 9c5.158 0 8.69-3.951 8.69-8.734 0-.58-.073-1.125-.19-1.644z"/>
                            </svg>
                            Import from Google Drive
                        </button>
                    </li>
                    <li id="snaw-admin-section" class="hidden">
                        <hr style="border-color: var(--border-secondary); margin: 8px 0;" />
                        <button
                            id="view-all-files-btn"
                            class="flex items-center w-full px-4 py-2 rounded-md shadow-sm"
                            style="background-color: #6366F1; color: white;"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-eye mr-2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                            View All Files (Snaw Only)
                        </button>
                    </li>
                </ul>
            </aside>

            <!-- File Explorer -->
            <main id="main-content-area" class="flex-grow p-6 overflow-auto" style="background-color: var(--bg-window-content);">
                <!-- Breadcrumbs -->
                <nav class="text-sm mb-4">
                    <ol id="breadcrumbs" class="list-none p-0 inline-flex">
                        <!-- Breadcrumbs will be dynamically inserted here -->
                    </ol>
                </nav>

                <!-- File/Folder List -->
                <div id="file-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 min-h-[200px] p-4 border-2 border-dashed border-transparent rounded-xl transition-all duration-200">
                    <!-- Files and folders will be dynamically inserted here -->
                </div>
            </main>
        </div>
    </div>

    <script>
        // Base URL for your backend server (change this to your Render URL!)
        const BASE_URL = 'https://snugos-server-api.onrender.com';

        // Google API Client ID (this will be used by the frontend for Picker API)
        // This is *not* a secret, it's public knowledge for your app.
        // It should match the GOOGLE_CLIENT_ID you set in Render's environment variables.
        const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // <<< REPLACE WITH YOUR ACTUAL GOOGLE CLIENT ID

        // Global state variables
        let token = localStorage.getItem('jwtToken');
        let currentUser = null; // Stores { id, username }
        let currentPath = '/';
        let authMode = 'login'; // 'login' or 'register'
        let confirmActionCallback = null;
        let inputDialogConfirmCallback = null;
        let isAdminView = false; // Flag for 'snaw' to view all files

        // DOM Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageDialog = document.getElementById('message-dialog');
        const messageText = document.getElementById('message-text');
        const messageConfirmBtn = document.getElementById('message-confirm-btn');
        const messageCancelBtn = document.getElementById('message-cancel-btn');
        const inputDialog = document.getElementById('input-dialog');
        const inputDialogTitle = document.getElementById('input-dialog-title');
        const inputDialogField = document.getElementById('input-dialog-field');
        const inputDialogConfirmBtn = document.getElementById('input-dialog-confirm-btn');
        const inputDialogCancelBtn = document.getElementById('input-dialog-cancel-btn');
        const loginPage = document.getElementById('login-page');
        const appContent = document.getElementById('app-content');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const authMessage = document.getElementById('auth-message');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authBtnText = document.getElementById('auth-btn-text');
        const authSpinner = document.getElementById('auth-spinner');
        const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
        const googleLoginBtn = document.getElementById('google-login-btn'); // New Google Login Button
        const loggedInUserSpan = document.getElementById('logged-in-user');
        const logoutBtn = document.getElementById('logout-btn');
        const createFolderBtn = document.getElementById('create-folder-btn');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const fileUploadInput = document.getElementById('file-upload-input');
        const breadcrumbsNav = document.getElementById('breadcrumbs');
        const fileListDiv = document.getElementById('file-list');
        const mainContentArea = document.getElementById('main-content-area');
        const importGoogleDriveBtn = document.getElementById('import-google-drive-btn'); // New Google Drive Import Button
        const snawAdminSection = document.getElementById('snaw-admin-section'); // Snaw admin section
        const viewAllFilesBtn = document.getElementById('view-all-files-btn'); // View All Files Button

        // --- Google API & Picker API specific variables ---
        let googleApiClientReady = false;
        let googlePickerReady = false;

        // gapiLoaded function is called by the Google API script.
        // It loads the 'client' library for OAuth and 'picker' for the file picker.
        function gapiLoaded() {
            gapi.load('client:picker', () => {
                googleApiClientReady = true;
                googlePickerReady = true; // Both are ready from this load
                console.log("Google API client and Picker loaded.");
                // Check for Google OAuth success/error from URL params on app load
                handleGoogleCallback();
            });
        }

        // --- Utility Functions for Modals ---

        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function showMessage(msg, onConfirm = null, showCancel = false, onCancel = null) {
            messageText.textContent = msg;
            messageCancelBtn.classList.toggle('hidden', !showCancel);
            messageDialog.classList.remove('hidden');

            // Clear previous event listeners to prevent multiple calls
            messageConfirmBtn.onclick = null;
            messageCancelBtn.onclick = null;

            messageConfirmBtn.onclick = () => {
                messageDialog.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            if (showCancel) {
                messageCancelBtn.onclick = () => {
                    messageDialog.classList.add('hidden');
                    if (onCancel) onCancel();
                };
            }
        }

        function showInputDialog(title, placeholder, initialValue, onConfirmCallback) {
            inputDialogTitle.textContent = title;
            inputDialogField.placeholder = placeholder;
            inputDialogField.value = initialValue;
            inputDialog.classList.remove('hidden');
            inputDialogField.focus();

            // Store the callback
            inputDialogConfirmCallback = onConfirmCallback;

            // Clear previous event listeners
            inputDialogConfirmBtn.onclick = null;
            inputDialogCancelBtn.onclick = null;

            inputDialogConfirmBtn.onclick = async () => {
                const value = inputDialogField.value.trim();
                const success = await inputDialogConfirmCallback(value);
                if (success) {
                    inputDialog.classList.add('hidden');
                }
            };

            inputDialogCancelBtn.onclick = () => {
                inputDialog.classList.add('hidden');
            };
        }

        // --- Icon SVGs (Inline) ---
        const getFolderIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-folder mr-3 flex-shrink-0" style="color: currentColor;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>`;
        const getFileIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-file-text mr-3 flex-shrink-0" style="color: currentColor;"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v6h6"/><path d="M10 12H8"/><path d="M16 16H8"/><path d="M16 20H8"/></svg>`;
        const getEditIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
        const getTrashIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
        const getEyeIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
        const getEyeOffIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-eye-off"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7a18.06 18.06 0 0 1 5.34-4.34M7.52 3.13A9.01 9.01 0 0 1 12 4c7 0 10 7 10 7a18.06 18.06 0 0 1-2.5 3.06"/><circle cx="12" cy="12" r="3"/><line x1="2" x2="22" y1="2" y2="22"/></svg>`;
        const getShareIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>`;

        // --- Authentication Functions ---

        async function fetchUserProfile() {
            if (!token) return;
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/profile/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.profile;
                    renderApp();
                } else {
                    console.error("Failed to fetch user profile:", response.statusText);
                    token = null;
                    localStorage.removeItem('jwtToken');
                    renderApp(); // Go back to login
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                token = null;
                localStorage.removeItem('jwtToken');
                renderApp(); // Go back to login
            } finally {
                hideLoading();
            }
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value;

            if (!username || !password) {
                authMessage.textContent = 'Please enter both username and password.';
                authMessage.classList.remove('hidden');
                return;
            }

            authMessage.classList.add('hidden');
            authSubmitBtn.disabled = true;
            authSpinner.classList.remove('hidden');
            authBtnText.textContent = authMode === 'register' ? 'Registering...' : 'Logging in...';

            try {
                const endpoint = authMode === 'register' ? '/api/register' : '/api/login';
                const response = await fetch(`${BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();

                if (data.success) {
                    token = data.token;
                    localStorage.setItem('jwtToken', token);
                    currentUser = data.user;
                    renderApp();
                } else {
                    authMessage.textContent = data.message || (authMode === 'register' ? 'Registration failed.' : 'Login failed.');
                    authMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Authentication error:", error);
                authMessage.textContent = 'Network error or server unavailable.';
                authMessage.classList.remove('hidden');
            } finally {
                authSubmitBtn.disabled = false;
                authSpinner.classList.add('hidden');
                authBtnText.textContent = authMode === 'register' ? 'Register' : 'Login';
            }
        }

        function handleLogout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('jwtToken');
            // Reset admin view flag on logout
            isAdminView = false;
            renderApp();
            showMessage('You have been logged out.');
        }

        // --- File Management Functions ---

        async function fetchFiles() {
            if (!token || !currentUser) {
                fileListDiv.innerHTML = ''; // Clear content if not logged in
                return;
            }

            showLoading();
            try {
                let apiUrl = `${BASE_URL}/api/files/my?path=${encodeURIComponent(currentPath)}`;
                // If 'snaw' and in admin view, fetch all files
                if (currentUser.username === 'snaw' && isAdminView) {
                    apiUrl = `${BASE_URL}/api/admin/files`;
                }

                const response = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    // When in admin view for 'snaw', show full paths
                    if (currentUser.username === 'snaw' && isAdminView) {
                        renderFileListAdmin(data.items);
                    } else {
                        const sortedItems = data.items.sort((a, b) => {
                            const isAFolder = a.mime_type === 'application/vnd.snugos.folder';
                            const isBFolder = b.mime_type === 'application/vnd.snugos.folder';

                            if (isAFolder && !isBFolder) return -1;
                            if (!isAFolder && isBFolder) return 1;
                            return a.file_name.localeCompare(b.file_name);
                        });
                        renderFileList(sortedItems);
                    }
                } else {
                    showMessage(data.message || "Failed to load files.");
                    renderFileList([]);
                }
            } catch (error) {
                console.error("Error fetching files:", error);
                showMessage("Network error while fetching files. Please try again.");
                renderFileList([]);
            } finally {
                hideLoading();
            }
        }

        async function handleCreateFolder() {
            showInputDialog('Create New Folder', 'Folder Name', '', async (name) => {
                if (!name.trim()) {
                    showMessage("Folder name cannot be empty.");
                    return false;
                }
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/folders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name: name.trim(), path: currentPath })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage("Folder created successfully!");
                        fetchFiles(); // Re-fetch files to update UI
                        return true;
                    } else {
                        showMessage(data.message || "Failed to create folder.");
                        return false;
                    }
                } catch (error) {
                    console.error("Error creating folder:", error);
                    showMessage("Network error creating folder.");
                    return false;
                } finally {
                    hideLoading();
                }
            });
        }

        // Centralized file upload logic
        async function uploadFiles(filesToUpload) {
            if (!filesToUpload || filesToUpload.length === 0) return;

            showLoading();
            let allSuccess = true;
            let messages = [];

            for (const file of filesToUpload) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('path', currentPath);
                formData.append('is_public', false); // Default to private

                try {
                    const response = await fetch(`${BASE_URL}/api/files/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        messages.push(`"${file.name}" uploaded successfully.`);
                    } else {
                        allSuccess = false;
                        messages.push(`Failed to upload "${file.name}": ${data.message || 'Server error'}.`);
                    }
                } catch (error) {
                    allSuccess = false;
                    messages.push(`Network error uploading "${file.name}".`);
                    console.error(`Error uploading "${file.name}":`, error);
                }
            }
            showMessage(messages.join('\n'));
            fetchFiles(); // Re-fetch files to update UI
            hideLoading();
        }

        function handleUploadClick() {
            fileUploadInput.click();
        }

        // Handles file input change (manual selection)
        function handleFileInputChange(event) {
            const files = event.target.files;
            uploadFiles(Array.from(files));
            event.target.value = null; // Reset file input
        }

        function handleRename(item) {
            showInputDialog(`Rename ${item.file_name}`, 'New Name', item.file_name, async (newName) => {
                if (!newName.trim()) {
                    showMessage("Name cannot be empty.");
                    return false;
                }
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/files/${item.id}/rename`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ newName: newName.trim() })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage("Item renamed successfully.");
                        fetchFiles(); // Re-fetch files
                        return true;
                    } else {
                        showMessage(data.message || "Failed to rename item.");
                        return false;
                    }
                } catch (error) {
                    console.error("Error renaming item:", error);
                    showMessage("Network error renaming item.");
                    return false;
                } finally {
                    hideLoading();
                }
            });
        }

        function handleDeleteItem(item) {
            showMessage(`Are you sure you want to delete "${item.file_name}"? This action cannot be undone.`, async () => {
                showLoading();
                try {
                    const response = await fetch(`${BASE_URL}/api/files/${item.id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (data.success) {
                        showMessage(`"${item.file_name}" deleted successfully.`);
                        fetchFiles(); // Re-fetch files
                    } else {
                        showMessage(data.message || "Failed to delete item.");
                    }
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showMessage("Network error deleting item.");
                } finally {
                    hideLoading();
                }
            }, true); // showCancel = true
        }

        async function handleTogglePublic(item) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/files/${item.id}/toggle-public`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ is_public: !item.is_public })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(`"${item.file_name}" is now ${data.file.is_public ? 'public' : 'private'}.`);
                    fetchFiles(); // Re-fetch files
                } else {
                    showMessage(data.message || "Failed to change public status.");
                }
            } catch (error) {
                console.error("Error toggling public status:", error);
                showMessage("Network error changing public status.");
            } finally {
                hideLoading();
            }
        }

        async function handleShareLink(item) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/files/${item.id}/share-link`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    // Copy to clipboard
                    navigator.clipboard.writeText(data.shareUrl).then(() => {
                        showMessage("Share link copied to clipboard!");
                    }).catch(err => {
                        // Fallback for older browsers or if clipboard API fails (e.g., iframe restrictions)
                        const textarea = document.createElement('textarea');
                        textarea.value = data.shareUrl;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showMessage("Share link copied to clipboard! (Fallback method)");
                        console.warn("Clipboard API not available, falling back to execCommand.");
                    });
                } else {
                    showMessage(data.message || "Failed to generate share link.");
                }
            } catch (error) {
                console.error("Error generating share link:", error);
                showMessage("Network error generating share link.");
            } finally {
                hideLoading();
            }
        }

        // Handle moving files/folders via drag and drop
        async function handleMoveItem(draggedItemId, targetPath) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/files/${draggedItemId}/move`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ targetPath: targetPath })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(data.message || "Item moved successfully.");
                    fetchFiles(); // Re-fetch files to update UI
                } else {
                    showMessage(data.message || "Failed to move item.");
                }
            } catch (error) {
                console.error("Error moving item:", error);
                showMessage("Network error moving item.");
            } finally {
                hideLoading();
            }
        }

        // --- Google Drive Integration ---

        // Initiates Google OAuth flow via backend
        async function linkGoogleAccount() {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/google-auth`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success && data.authUrl) {
                    window.location.href = data.authUrl; // Redirect to Google OAuth page
                } else {
                    showMessage(data.message || "Failed to initiate Google authentication.");
                }
            } catch (error) {
                console.error("Error initiating Google auth:", error);
                showMessage("Network error initiating Google authentication.");
            } finally {
                hideLoading();
            }
        }

        // Handles the redirect back from Google OAuth
        function handleGoogleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('google_auth_success')) {
                showMessage("Google Drive linked successfully!");
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                fetchUserProfile(); // Re-fetch profile to update UI if needed (e.g. show Google import button)
            } else if (urlParams.has('google_auth_error')) {
                const errorMsg = decodeURIComponent(urlParams.get('google_auth_error'));
                showMessage(`Google Drive linking failed: ${errorMsg}`);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Creates and shows the Google Picker dialog
        async function createGooglePicker() {
            if (!googleApiClientReady || !googlePickerReady || !currentUser || !currentUser.google_access_token) {
                showMessage("Google APIs not ready or account not linked. Please try again.");
                return;
            }

            const token = currentUser.google_access_token; // Use the access token from the current user's profile

            const view = new google.picker.View(google.picker.ViewId.DOCS);
            view.setMimeTypes('image/*,audio/*,video/*,application/pdf,text/plain,application/vnd.google-apps.document,application/vnd.google-apps.spreadsheet,application/vnd.google-apps.presentation'); // Example MIME types

            const picker = new google.picker.PickerBuilder()
                .enableFeature(google.picker.Feature.NAV_ARGS)
                .setAppId(GOOGLE_CLIENT_ID) // Use your Google Client ID here
                .setOAuthToken(token)
                .addView(view)
                .addView(new google.picker.DocsUploadView()) // Allow direct upload from picker
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        // Callback function for the Google Picker
        async function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                const doc = data[google.picker.Response.DOCUMENTS][0];
                const fileId = doc.id;
                const fileName = doc.name;
                const mimeType = doc.mimeJsType || doc.mimeType; // picker provides mimeJsType, fallback to mimeType

                showMessage(`Importing "${fileName}" from Google Drive...`);
                // Call your backend to import the file
                await importGoogleDriveFile(fileId, fileName, mimeType, currentPath);

            } else if (data[google.picker.Response.ACTION] === google.picker.Action.CANCEL) {
                showMessage('Google Drive import cancelled.');
            }
        }

        // Calls backend to import file from Google Drive to S3
        async function importGoogleDriveFile(fileId, fileName, mimeType, parentPath) {
            showLoading();
            try {
                const response = await fetch(`${BASE_URL}/api/google-drive/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ fileId, fileName, mimeType, parentPath })
                });
                const data = await response.json();
                if (data.success) {
                    showMessage(data.message || `File "${fileName}" imported successfully.`);
                    fetchFiles(); // Refresh file list
                } else {
                    showMessage(data.message || `Failed to import "${fileName}".`);
                }
            } catch (error) {
                console.error("Error importing Google Drive file:", error);
                showMessage("Network error during Google Drive import.");
            } finally {
                hideLoading();
            }
        }

        // --- UI Rendering Functions ---

        function renderBreadcrumbs() {
            breadcrumbsNav.innerHTML = '';
            const pathSegments = currentPath.split('/').filter(segment => segment !== '');

            let myDriveLi = document.createElement('li');
            myDriveLi.className = 'flex items-center';
            let myDriveBtn = document.createElement('button');
            myDriveBtn.className = 'hover:underline font-medium';
            myDriveBtn.style.setProperty('color', 'var(--text-primary)'); /* Apply text-primary directly */
            myDriveBtn.textContent = 'My Drive';
            myDriveBtn.onclick = () => {
                currentPath = '/';
                isAdminView = false; // Exit admin view if navigating from breadcrumbs
                renderApp();
            };
            myDriveLi.appendChild(myDriveBtn);
            breadcrumbsNav.appendChild(myDriveLi);

            // Hide breadcrumbs if in admin view
            if (isAdminView && currentUser.username === 'snaw') {
                breadcrumbsNav.classList.add('hidden');
                // Display a clear indicator for admin view
                const adminIndicator = document.createElement('li');
                adminIndicator.className = 'flex items-center';
                adminIndicator.innerHTML = '<span class="mx-2 text-gray-400" style="color: var(--text-secondary);">/</span><span class="font-bold" style="color: var(--text-primary);">All Files (Admin View)</span>';
                breadcrumbsNav.appendChild(adminIndicator);
                breadcrumbsNav.classList.remove('hidden'); // Show it
                return;
            } else {
                breadcrumbsNav.classList.remove('hidden'); // Ensure breadcrumbs are visible for normal view
            }

            let accumulatedPath = '/';
            pathSegments.forEach((segment, index) => {
                accumulatedPath += segment + '/';
                let li = document.createElement('li');
                li.className = 'flex items-center';
                li.innerHTML = '<span class="mx-2 text-gray-400" style="color: var(--text-secondary);">/</span>';
                let btn = document.createElement('button');
                btn.className = 'hover:underline font-medium';
                btn.style.setProperty('color', 'var(--text-primary)'); /* Apply text-primary directly */
                btn.textContent = segment;
                // Capture the path for this segment in a closure
                const navPath = accumulatedPath;
                btn.onclick = () => {
                    currentPath = navPath;
                    renderApp();
                };
                li.appendChild(btn);
                breadcrumbsNav.appendChild(li);
            });
        }


        // Renders file list for normal user/folder view
        function renderFileList(items) {
            fileListDiv.innerHTML = ''; // Clear previous items

            if (items.length === 0) {
                fileListDiv.innerHTML = `
                    <p class="col-span-full text-center text-gray-500 py-8" style="color: var(--text-secondary);">
                        This folder is empty. Create a new folder or upload a file!
                    </p>
                `;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shadow-lg hover:shadow-xl transition-shadow duration-200 p-4 flex flex-col items-start space-y-3 relative';
                itemDiv.style.setProperty('background-color', 'var(--bg-window)');
                itemDiv.style.setProperty('border', '1px solid var(--border-primary)');
                itemDiv.style.setProperty('color', 'var(--text-primary)');
                itemDiv.style.setProperty('border-radius', '3px'); /* Apply consistent border-radius */

                itemDiv.draggable = true; // Make items draggable
                itemDiv.dataset.itemId = item.id;
                itemDiv.dataset.itemType = item.mime_type;
                itemDiv.dataset.itemName = item.file_name;
                itemDiv.dataset.itemPath = item.path; // Store item's current path for drag validation

                // Drag start event
                itemDiv.addEventListener('dragstart', (e) => {
                    // Store item details as JSON in dataTransfer
                    e.dataTransfer.setData('application/json', JSON.stringify({
                        id: item.id,
                        type: item.mime_type,
                        name: item.file_name,
                        path: item.path // Include current path to validate self-move later
                    }));
                    e.dataTransfer.effectAllowed = 'move';
                    // Optional: Add a class to the dragged item for visual feedback
                    itemDiv.classList.add('opacity-50');
                });

                itemDiv.addEventListener('dragend', (e) => {
                    // Remove the visual feedback class
                    itemDiv.classList.remove('opacity-50');
                });


                const isFolder = item.mime_type === 'application/vnd.snugos.folder';
                const nameElement = document.createElement(isFolder ? 'button' : 'a');
                nameElement.className = 'flex items-center text-left group w-full';
                nameElement.style.setProperty('color', 'var(--text-primary)'); // Ensure text color is primary
                nameElement.innerHTML = (isFolder ? getFolderIcon() : getFileIcon()) + `<span class="font-${isFolder ? 'semibold' : 'medium'} text-lg truncate flex-grow">${item.file_name}</span>`;

                if (isFolder) {
                    nameElement.onclick = () => {
                        currentPath = currentPath === '/' ? `/${item.file_name}/` : `${currentPath}${item.file_name}/`;
                        isAdminView = false; // Ensure not in admin view when navigating into folder
                        renderApp();
                    };

                    // Make folders drop targets
                    itemDiv.addEventListener('dragover', handleDropTargetDragOver);
                    itemDiv.addEventListener('dragleave', handleDropTargetDragLeave);
                    itemDiv.addEventListener('drop', handleDrop);

                    // Add a data attribute to indicate it's a folder drop target
                    itemDiv.dataset.isDropTarget = 'true';
                    itemDiv.dataset.dropTargetPath = currentPath + item.file_name + '/'; // Path where dropped item will reside
                } else {
                    nameElement.href = item.s3_url;
                    nameElement.target = '_blank';
                    nameElement.rel = 'noopener noreferrer';
                }
                itemDiv.appendChild(nameElement);

                // Actions div
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex flex-wrap gap-2 pt-2 border-t w-full justify-start mt-auto';
                actionsDiv.style.setProperty('border-color', 'var(--border-secondary)');

                // Rename Button
                const renameBtn = document.createElement('button');
                renameBtn.className = 'item-action-btn'; /* Use new class for consistent button sizing/style */
                renameBtn.title = 'Rename';
                renameBtn.innerHTML = getEditIcon();
                renameBtn.onclick = () => handleRename(item);
                actionsDiv.appendChild(renameBtn);

                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'item-action-btn';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = getTrashIcon();
                deleteBtn.onclick = () => handleDeleteItem(item);
                actionsDiv.appendChild(deleteBtn);

                if (!isFolder) {
                    // Toggle Public Button
                    const togglePublicBtn = document.createElement('button');
                    togglePublicBtn.className = 'item-action-btn';
                    togglePublicBtn.title = item.is_public ? "Make Private" : "Make Public";
                    togglePublicBtn.innerHTML = item.is_public ? getEyeOffIcon() : getEyeIcon();
                    togglePublicBtn.onclick = () => handleTogglePublic(item);
                    actionsDiv.appendChild(togglePublicBtn);

                    // Share Link Button
                    const shareLinkBtn = document.createElement('button');
                    shareLinkBtn.className = 'item-action-btn';
                    shareLinkBtn.title = 'Get Share Link';
                    shareLinkBtn.innerHTML = getShareIcon();
                    shareLinkBtn.onclick = () => handleShareLink(item);
                    actionsDiv.appendChild(shareLinkBtn);
                }

                itemDiv.appendChild(actionsDiv);
                fileListDiv.appendChild(itemDiv);
            });
        }

        // Renders file list for 'snaw' admin view (shows paths)
        function renderFileListAdmin(items) {
            fileListDiv.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left';
            table.style.setProperty('color', 'var(--text-primary)');
            table.style.setProperty('border', '1px solid var(--border-primary)');
            table.style.setProperty('background-color', 'var(--bg-window)');
            table.style.setProperty('border-radius', '3px');

            table.innerHTML = `
                <thead style="background-color: var(--bg-title-bar); color: var(--text-title-bar);">
                    <tr>
                        <th class="p-3">Type</th>
                        <th class="p-3">Name</th>
                        <th class="p-3">Owner</th>
                        <th class="p-3">Path</th>
                        <th class="p-3">Size</th>
                        <th class="p-3">Public</th>
                        <th class="p-3">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="p-3 text-center" style="color: var(--text-secondary);">No files found across all users.</td></tr>`;
            }

            items.forEach(item => {
                const isFolder = item.mime_type === 'application/vnd.snugos.folder';
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.style.setProperty('border-color', 'var(--border-secondary)');
                row.style.setProperty('background-color', 'var(--bg-window-content)'); // Alternating row color could be added with nth-child

                let fileNameDisplay = item.file_name;
                if (!isFolder) {
                    // Make file names clickable to open S3 URL
                    fileNameDisplay = `<a href="${item.s3_url}" target="_blank" rel="noopener noreferrer" class="hover:underline">${item.file_name}</a>`;
                }

                row.innerHTML = `
                    <td class="p-3">${isFolder ? 'Folder' : 'File'}</td>
                    <td class="p-3">${fileNameDisplay}</td>
                    <td class="p-3">${item.user_id}</td> <!-- Placeholder for owner username, if available -->
                    <td class="p-3 truncate max-w-[200px]">${item.path}</td>
                    <td class="p-3">${item.file_size ? (item.file_size / 1024 / 1024).toFixed(2) + ' MB' : '-'}</td>
                    <td class="p-3">${item.is_public ? 'Yes' : 'No'}</td>
                    <td class="p-3">
                        <div class="flex flex-wrap gap-1">
                            <button class="item-action-btn" title="Rename" onclick="handleRename(${JSON.stringify(item).replace(/"/g, '&quot;')})">${getEditIcon()}</button>
                            <button class="item-action-btn" title="Delete" onclick="handleDeleteItem(${JSON.stringify(item).replace(/"/g, '&quot;')})" style="color: #EF4444;">${getTrashIcon()}</button>
                            ${!isFolder ? `<button class="item-action-btn" title="${item.is_public ? 'Make Private' : 'Make Public'}" onclick="handleTogglePublic(${JSON.stringify(item).replace(/"/g, '&quot;')})">${item.is_public ? getEyeOffIcon() : getEyeIcon()}</button>` : ''}
                            ${!isFolder ? `<button class="item-action-btn" title="Get Share Link" onclick="handleShareLink(${JSON.stringify(item).replace(/"/g, '&quot;')})">${getShareIcon()}</button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            fileListDiv.appendChild(table);
        }

        // --- Drag and Drop Handlers (for uploads and internal moves) ---

        function handleDropTargetDragOver(e) {
            e.preventDefault(); // Essential to allow drop
            e.stopPropagation();
            // Only apply hover if it's a file drop or an internal item drag
            if (e.dataTransfer.types.includes('Files') || e.dataTransfer.types.includes('application/json')) {
                let targetElement = e.currentTarget;
                // If dropping on a folder item or the main file list area
                if (targetElement.dataset.isDropTarget === 'true' || targetElement.id === 'file-list') {
                    targetElement.classList.add('drop-target-hover');
                }
            }
        }

        function handleDropTargetDragLeave(e) {
            e.stopPropagation();
            let targetElement = e.currentTarget;
            if (targetElement.dataset.isDropTarget === 'true' || targetElement.id === 'file-list') {
                targetElement.classList.remove('drop-target-hover');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            let targetElement = e.currentTarget;
            targetElement.classList.remove('drop-target-hover');

            // Handle files dragged from outside the browser (upload)
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const files = Array.from(e.dataTransfer.files);
                await uploadFiles(files);
                return;
            }

            // Handle internal drag and drop (move file/folder)
            try {
                const draggedItemData = JSON.parse(e.dataTransfer.getData('application/json'));
                const draggedItemId = draggedItemData.id;
                const draggedItemType = draggedItemData.type;
                const draggedItemName = draggedItemData.name;
                const draggedItemCurrentPath = draggedItemData.path; // Current parent path of the dragged item

                let dropTargetPath;

                // Determine the target path based on where the item was dropped
                if (targetElement.id === 'file-list') {
                    // Dropped on the main file list area (meaning move to current directory)
                    dropTargetPath = currentPath;
                } else if (targetElement.dataset.isDropTarget === 'true' && targetElement.dataset.itemType === 'application/vnd.snugos.folder') {
                    // Dropped on a specific folder item
                    dropTargetPath = targetElement.dataset.dropTargetPath;
                } else {
                    // Invalid drop target (e.g., dropped on a file item)
                    showMessage("Invalid drop target. You can only drop items into folders or the current directory's main area.");
                    return;
                }

                // Validation 1: Prevent dropping an item onto itself
                if (draggedItemId === targetElement.dataset.itemId && dropTargetPath === draggedItemCurrentPath) {
                    showMessage("Cannot drop an item onto itself (already in target location).");
                    return;
                }

                // Validation 2: Prevent moving an item into its current parent (no-op)
                if (dropTargetPath === draggedItemCurrentPath) {
                    showMessage("Item is already in this location.");
                    return;
                }

                // Validation 3: Prevent moving a folder into its own descendant
                const draggedItemFullPath = draggedItemCurrentPath + draggedItemName + (draggedItemType === 'application/vnd.snugos.folder' ? '/' : '');
                if (draggedItemType === 'application/vnd.snugos.folder' && dropTargetPath.startsWith(draggedItemFullPath)) {
                     showMessage("Cannot move a folder into its own subfolder.");
                     return;
                }

                // Execute the move operation
                await handleMoveItem(draggedItemId, dropTargetPath);

            } catch (error) {
                console.error("Drag and drop error:", error);
                showMessage("An error occurred during drag and drop. " + error.message);
            }
        }


        // --- Main App Renderer ---
        function renderApp() {
            if (token && currentUser) {
                loginPage.classList.add('hidden');
                appContent.classList.remove('hidden');
                loggedInUserSpan.innerHTML = `Logged in as: <span class="font-semibold" style="color: var(--text-primary);">${currentUser.username}</span>`;

                // Show/hide Snaw admin section
                if (currentUser.username === 'snaw') {
                    snawAdminSection.classList.remove('hidden');
                } else {
                    snawAdminSection.classList.add('hidden');
                    isAdminView = false; // Ensure admin view is off if not 'snaw'
                }

                renderBreadcrumbs();
                fetchFiles();
            } else {
                loginPage.classList.remove('hidden');
                appContent.classList.add('hidden');
                // Reset login/register form
                usernameInput.value = '';
                passwordInput.value = '';
                authMessage.classList.add('hidden');
                authSpinner.classList.add('hidden');
                authSubmitBtn.disabled = false;
                if (authMode === 'register') {
                    authTitle.textContent = 'Register to SnugOS Drive';
                    authBtnText.textContent = 'Register';
                    toggleAuthModeBtn.textContent = 'Already have an account? Login';
                } else {
                    authTitle.textContent = 'Login to SnugOS Drive';
                    authBtnText.textContent = 'Login';
                    toggleAuthModeBtn.textContent = 'Need an account? Register';
                }
            }
        }

        // --- Event Listeners ---
        window.onload = () => {
            renderApp(); // Initial render based on existing token
        };

        authForm.addEventListener('submit', handleAuthSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        createFolderBtn.addEventListener('click', handleCreateFolder);
        uploadFileBtn.addEventListener('click', handleUploadClick);
        fileUploadInput.addEventListener('change', handleFileInputChange);

        // Google Login button
        googleLoginBtn.addEventListener('click', linkGoogleAccount);
        // Google Drive Import button
        importGoogleDriveBtn.addEventListener('click', createGooglePicker);

        // Snaw admin button
        viewAllFilesBtn.addEventListener('click', () => {
            isAdminView = !isAdminView; // Toggle admin view
            // When toggling to admin view, reset current path to root for full file list
            if (isAdminView) {
                currentPath = '/';
            }
            renderApp(); // Re-render to fetch new data
        });

        // Global drag and drop listeners for the entire file list area (for upload to current directory)
        fileListDiv.addEventListener('dragover', handleDropTargetDragOver);
        fileListDiv.addEventListener('dragleave', handleDropTargetDragLeave);
        fileListDiv.addEventListener('drop', handleDrop);


        toggleAuthModeBtn.addEventListener('click', () => {
            authMode = authMode === 'login' ? 'register' : 'login';
            renderApp();
        });

    </script>
</body>
</html>
